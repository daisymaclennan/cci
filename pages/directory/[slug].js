import React, { useState, useEffect } from 'react'
import { useRouter } from 'next/router'
import Layout from '../../components/layout'
import api from '../../lib/api'
import OrgDetailBox from '../../components/org-detail-box'
import PrimaryButton from '../../components/primary-button'
import IconLink from '../../components/icon-link'
import LogoHeader from '../../components/logo-header'
import Link from 'next/link'

import Carousel from '../../components/carousel'

import EmblaCarouselReact from 'embla-carousel-react'



const Page = ({ entry }) => (
  <Layout>
    <LogoHeader>
      <img src={`/static/uploads/${entry.logo}`} alt={`${entry.name}'s logo`}/>
      <Link href="/directory">
          <IconLink>
            <h5>Close</h5>
            <svg width="9" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8.09375 6L11.2188 9.125C11.4062 9.3125 11.5 9.5625 11.5 9.8125C11.5 10.0938 11.4062 10.3438 11.2188 10.5312L10.5312 11.2188C10.3125 11.4062 10.0625 11.5 9.8125 11.5C9.53125 11.5 9.3125 11.4062 9.125 11.2188L6 8.09375L2.875 11.2188C2.6875 11.4062 2.4375 11.5 2.1875 11.5C1.90625 11.5 1.65625 11.4062 1.46875 11.2188L0.78125 10.5312C0.59375 10.3438 0.5 10.0938 0.5 9.8125C0.5 9.5625 0.59375 9.3125 0.78125 9.125L3.90625 6L0.78125 2.875C0.59375 2.6875 0.5 2.46875 0.5 2.1875C0.5 1.9375 0.59375 1.6875 0.78125 1.46875L1.46875 0.78125C1.65625 0.59375 1.90625 0.5 2.1875 0.5C2.4375 0.5 2.6875 0.59375 2.875 0.78125L6 3.90625L9.125 0.78125C9.3125 0.59375 9.53125 0.5 9.8125 0.5C10.0625 0.5 10.3125 0.59375 10.5312 0.78125L11.2188 1.46875C11.4062 1.6875 11.5 1.9375 11.5 2.1875C11.5 2.46875 11.4062 2.6875 11.2188 2.875L8.09375 6Z" fill="#000000"/>
            </svg>
          </IconLink>
      </Link>
    </LogoHeader>

    <OrgDetailBox>
      <div className="website">
        <svg className="icon--website" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.875 0.75C11.1797 0.75 11.4375 0.867188 11.6719 1.07812C11.8828 1.3125 12 1.57031 12 1.875V10.125C12 10.4531 11.8828 10.7109 11.6719 10.9219C11.4375 11.1562 11.1797 11.25 10.875 11.25H1.125C0.796875 11.25 0.539062 11.1562 0.328125 10.9219C0.09375 10.7109 0 10.4531 0 10.125V1.875C0 1.57031 0.09375 1.3125 0.328125 1.07812C0.539062 0.867188 0.796875 0.75 1.125 0.75H10.875ZM3 3.46875V2.53125C3 2.46094 2.95312 2.39062 2.90625 2.34375C2.85938 2.29688 2.78906 2.25 2.71875 2.25H1.78125C1.6875 2.25 1.61719 2.29688 1.57031 2.34375C1.52344 2.39062 1.5 2.46094 1.5 2.53125V3.46875C1.5 3.5625 1.52344 3.63281 1.57031 3.67969C1.61719 3.72656 1.6875 3.75 1.78125 3.75H2.71875C2.78906 3.75 2.85938 3.72656 2.90625 3.67969C2.95312 3.63281 3 3.5625 3 3.46875ZM10.5 3.46875V2.53125C10.5 2.46094 10.4531 2.39062 10.4062 2.34375C10.3594 2.29688 10.2891 2.25 10.2188 2.25H4.40625C4.3125 2.25 4.24219 2.29688 4.19531 2.34375C4.14844 2.39062 4.125 2.46094 4.125 2.53125V3.46875C4.125 3.5625 4.14844 3.63281 4.19531 3.67969C4.24219 3.72656 4.3125 3.75 4.40625 3.75H10.2188C10.2891 3.75 10.3594 3.72656 10.4062 3.67969C10.4531 3.63281 10.5 3.5625 10.5 3.46875Z" fill="#1D1D1D"/>
        </svg>
        <p className="text--website underline">{entry.website}</p>
      </div>

      <div className="phone">
        <svg className="icon--phone" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.5547 0.585938C11.6953 0.609375 11.7891 0.679688 11.8828 0.773438C11.9531 0.890625 12 1.00781 12 1.125C12 3.09375 11.5078 4.92188 10.5234 6.60938C9.53906 8.25 8.25 9.5625 6.60938 10.5234C4.92188 11.5078 3.09375 12 1.125 12C0.984375 12 0.867188 11.9766 0.773438 11.8828C0.65625 11.8125 0.585938 11.6953 0.585938 11.5547L0.0234375 9.11719C-0.0234375 9 0 8.88281 0.0703125 8.74219C0.117188 8.625 0.210938 8.53125 0.351562 8.48438L2.97656 7.35938C3.07031 7.3125 3.1875 7.3125 3.32812 7.33594C3.44531 7.35938 3.53906 7.42969 3.63281 7.52344L4.78125 8.92969C5.69531 8.50781 6.51562 7.94531 7.21875 7.21875C7.92188 6.51562 8.50781 5.69531 8.92969 4.78125L7.52344 3.60938C7.42969 3.53906 7.35938 3.44531 7.33594 3.32812C7.28906 3.21094 7.3125 3.09375 7.35938 2.95312L8.48438 0.328125C8.53125 0.234375 8.60156 0.140625 8.74219 0.0703125C8.85938 0.0234375 8.97656 0 9.11719 0.0234375L11.5547 0.585938Z" fill="#1D1D1D"/>
        </svg>
        <p className="text--phone underline">{entry.phone_num}</p>
      </div>

      <div className="email">
        <svg className="icon--email" width="12" height="10" viewBox="0 0 12 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.7656 3.47656C11.2031 3.92188 9.98438 4.8125 8.15625 6.125L7.92188 6.3125C7.54688 6.59375 7.26562 6.80469 7.03125 6.92188C6.65625 7.15625 6.30469 7.25 6 7.25C5.67188 7.25 5.34375 7.15625 4.96875 6.94531C4.73438 6.82812 4.45312 6.61719 4.07812 6.33594L3.84375 6.125C1.94531 4.76562 0.75 3.875 0.234375 3.47656C0.1875 3.45312 0.117188 3.45312 0.0703125 3.47656C0.0234375 3.5 0 3.54688 0 3.59375V8.375C0 8.70312 0.09375 8.96094 0.328125 9.17188C0.539062 9.40625 0.796875 9.5 1.125 9.5H10.875C11.1797 9.5 11.4375 9.40625 11.6719 9.17188C11.8828 8.96094 12 8.70312 12 8.375V3.59375C12 3.54688 11.9531 3.5 11.9062 3.45312C11.8594 3.42969 11.8125 3.42969 11.7656 3.47656ZM6 6.5C5.78906 6.5 5.53125 6.40625 5.25 6.21875C5.0625 6.125 4.82812 5.96094 4.52344 5.70312L4.28906 5.53906C2.36719 4.13281 1.05469 3.17188 0.375 2.63281L0.210938 2.51562C0.0703125 2.42188 0 2.25781 0 2.07031V1.625C0 1.32031 0.09375 1.0625 0.328125 0.828125C0.539062 0.617188 0.796875 0.5 1.125 0.5H10.875C11.1797 0.5 11.4375 0.617188 11.6719 0.828125C11.8828 1.0625 12 1.32031 12 1.625V2.07031C12 2.25781 11.9297 2.42188 11.7891 2.51562L11.6719 2.60938C10.9922 3.14844 9.67969 4.13281 7.71094 5.53906L7.47656 5.70312C7.14844 5.96094 6.91406 6.125 6.75 6.21875C6.44531 6.40625 6.1875 6.5 6 6.5Z" fill="#1D1D1D"/>
        </svg>
        <p className="text--email underline">{entry.email_address}</p>
      </div>

      <div className="address">
        <svg className="icon--address" width="9" height="13" viewBox="0 0 9 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.03125 12.2656C4.125 12.4297 4.28906 12.5 4.5 12.5C4.6875 12.5 4.85156 12.4297 4.96875 12.2656L6.53906 10.0156C7.3125 8.89062 7.82812 8.14062 8.08594 7.74219C8.4375 7.17969 8.67188 6.71094 8.8125 6.33594C8.92969 5.96094 9 5.51562 9 5C9 4.20312 8.78906 3.45312 8.39062 2.75C7.96875 2.07031 7.42969 1.53125 6.75 1.10938C6.04688 0.710938 5.29688 0.5 4.5 0.5C3.67969 0.5 2.92969 0.710938 2.25 1.10938C1.54688 1.53125 1.00781 2.07031 0.609375 2.75C0.1875 3.45312 0 4.20312 0 5C0 5.51562 0.046875 5.96094 0.1875 6.33594C0.304688 6.71094 0.539062 7.17969 0.914062 7.74219C1.14844 8.14062 1.66406 8.89062 2.46094 10.0156C3.09375 10.9297 3.60938 11.6797 4.03125 12.2656ZM4.5 6.875C3.98438 6.875 3.53906 6.71094 3.16406 6.33594C2.78906 5.96094 2.625 5.51562 2.625 5C2.625 4.48438 2.78906 4.0625 3.16406 3.6875C3.53906 3.3125 3.98438 3.125 4.5 3.125C5.01562 3.125 5.4375 3.3125 5.8125 3.6875C6.1875 4.0625 6.375 4.48438 6.375 5C6.375 5.51562 6.1875 5.96094 5.8125 6.33594C5.4375 6.71094 5.01562 6.875 4.5 6.875Z" fill="#1D1D1D"/>
        </svg>
        {entry.address && (
          <p className="text--address underline">{entry.address.concat(" ",entry.postcode)}</p>
        )}
      </div>
    </OrgDetailBox>


    <h3 className="org__sub-title">About</h3>
    <p>{entry.descr}</p>

    <CarouselContainer entry={entry}></CarouselContainer>


    <div className="org__buttons">
      <PrimaryButton href={`${entry.website}`}>
        Go to website
        <svg className="icon--website" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.875 0.75C11.1797 0.75 11.4375 0.867188 11.6719 1.07812C11.8828 1.3125 12 1.57031 12 1.875V10.125C12 10.4531 11.8828 10.7109 11.6719 10.9219C11.4375 11.1562 11.1797 11.25 10.875 11.25H1.125C0.796875 11.25 0.539062 11.1562 0.328125 10.9219C0.09375 10.7109 0 10.4531 0 10.125V1.875C0 1.57031 0.09375 1.3125 0.328125 1.07812C0.539062 0.867188 0.796875 0.75 1.125 0.75H10.875ZM3 3.46875V2.53125C3 2.46094 2.95312 2.39062 2.90625 2.34375C2.85938 2.29688 2.78906 2.25 2.71875 2.25H1.78125C1.6875 2.25 1.61719 2.29688 1.57031 2.34375C1.52344 2.39062 1.5 2.46094 1.5 2.53125V3.46875C1.5 3.5625 1.52344 3.63281 1.57031 3.67969C1.61719 3.72656 1.6875 3.75 1.78125 3.75H2.71875C2.78906 3.75 2.85938 3.72656 2.90625 3.67969C2.95312 3.63281 3 3.5625 3 3.46875ZM10.5 3.46875V2.53125C10.5 2.46094 10.4531 2.39062 10.4062 2.34375C10.3594 2.29688 10.2891 2.25 10.2188 2.25H4.40625C4.3125 2.25 4.24219 2.29688 4.19531 2.34375C4.14844 2.39062 4.125 2.46094 4.125 2.53125V3.46875C4.125 3.5625 4.14844 3.63281 4.19531 3.67969C4.24219 3.72656 4.3125 3.75 4.40625 3.75H10.2188C10.2891 3.75 10.3594 3.72656 10.4062 3.67969C10.4531 3.63281 10.5 3.5625 10.5 3.46875Z"/>
        </svg>
      </PrimaryButton>

    </div>
  </Layout>
)

const CarouselContainer = ({entry}) => {
  if(entry.images.length > 0){
    const [embla, setEmbla] = useState(null)
    const [currentIndex, setCurrentIndex] = useState(0)
    const [canScrollPrev, setScrollPrev] = useState(0)
    const [canScrollNext, setScrollNext] = useState(1)
    const scrollPrev = () => embla.scrollPrev()
    const scrollNext = () => embla.scrollNext()

    useEffect(() => {
      if (embla) {
        embla.on('select', () => {
          const currentIndex = embla.selectedScrollSnap()
          setCurrentIndex(currentIndex)

          const canScrollPrev = embla.canScrollPrev()
          setScrollPrev(canScrollPrev)

          const canScrollNext = embla.canScrollNext()
          setScrollNext(canScrollNext)
        })
      }
    }, [embla])

    return (
      <Carousel>
          <EmblaCarouselReact
            htmlTagName="div"
            className="carousel"
            emblaRef={c => setEmbla(c)}
            options={{
              loop: false,
              align: 'start'
            }}
          >
            <div className="carousel-item-container">
              {entry.images.map( image => (
                <div className="carousel-item">
                  <div className="carousel-item-inner">
                    <img src={`/static/uploads/${image.image_location}`} alt={`${entry.name}'s gallery image`}/>
                  </div>
                </div>
              ))}
            </div>
          </EmblaCarouselReact>
          <div className="navigation">
            <button className={`prev nav-button ${canScrollPrev ? 'dark' : 'light'}`} onClick={scrollPrev}>
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M0.125 4.71875C0.0625 4.8125 0.03125 4.90625 0.03125 5C0.03125 5.125 0.0625 5.1875 0.125 5.25L4.71875 9.90625C4.78125 9.96875 4.875 10 4.96875 10C5.0625 10 5.15625 9.96875 5.25 9.875L5.875 9.28125C5.9375 9.21875 5.96875 9.125 5.96875 9C5.96875 8.90625 5.9375 8.8125 5.875 8.75L2.15625 5L5.875 1.25C5.9375 1.1875 5.96875 1.125 5.96875 1C5.96875 0.90625 5.9375 0.8125 5.875 0.71875L5.25 0.09375C5.15625 0.03125 5.0625 0 4.96875 0C4.875 0 4.78125 0.03125 4.71875 0.09375L0.125 4.71875Z"/>
              </svg>
              Previous
            </button>
            <span className="slide-track">{currentIndex + 1}/{entry.images.length}</span>
            <button className={`next nav-button ${canScrollNext ? 'dark' : 'light'}`} onClick={scrollNext}>
              Next
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5.875 5.25V5.28125C5.9375 5.21875 5.96875 5.125 5.96875 5C5.96875 4.90625 5.9375 4.8125 5.875 4.71875L1.28125 0.09375C1.1875 0.03125 1.09375 0 1 0C0.90625 0 0.8125 0.03125 0.75 0.09375L0.125 0.71875C0.0625 0.8125 0.03125 0.90625 0.03125 1C0.03125 1.125 0.0625 1.1875 0.125 1.25L3.84375 5L0.125 8.75C0.0625 8.8125 0.03125 8.90625 0.03125 9C0.03125 9.125 0.0625 9.21875 0.125 9.28125L0.75 9.90625C0.8125 9.96875 0.90625 10 1 10C1.09375 10 1.1875 9.96875 1.28125 9.875L5.875 5.25Z"/>
              </svg>
            </button>
          </div>
      </Carousel>
    )
  }else{
    return <div/>
  }
}

Page.getInitialProps = async ctx => {
  const entry = await api(`org/${ctx.query.slug}`, { ctx })

  return {
    entry: entry.json
  }
}

export default Page
